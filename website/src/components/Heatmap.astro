---
interface Props {
  data: { date: string; count: number }[];
}

const { data } = Astro.props;

// Organize data into weeks (7 days per column)
function organizeIntoWeeks(dailyData: { date: string; count: number }[]) {
  const weeks: { date: string; count: number }[][] = [];
  let currentWeek: { date: string; count: number }[] = [];

  // Find the first day and pad to start on Sunday
  const firstDate = new Date(dailyData[0]?.date || new Date());
  const firstDayOfWeek = firstDate.getDay();

  // Add empty padding for first week
  for (let i = 0; i < firstDayOfWeek; i++) {
    currentWeek.push({ date: "", count: -1 });
  }

  for (const day of dailyData) {
    currentWeek.push(day);
    if (currentWeek.length === 7) {
      weeks.push(currentWeek);
      currentWeek = [];
    }
  }

  // Push remaining days
  if (currentWeek.length > 0) {
    weeks.push(currentWeek);
  }

  return weeks;
}

function getLevel(count: number): number {
  if (count <= 0) return 0;
  if (count === 1) return 1;
  if (count <= 3) return 2;
  if (count <= 5) return 3;
  return 4;
}

const weeks = organizeIntoWeeks(data);
const totalCount = data.reduce((sum, d) => sum + d.count, 0);
---

<div class="heatmap-container">
  <div class="heatmap-header">
    <span class="heatmap-total">{totalCount} thoughts this year</span>
  </div>

  <div class="heatmap-wrapper">
    <div class="heatmap-labels">
      <span>Sun</span>
      <span>Mon</span>
      <span>Tue</span>
      <span>Wed</span>
      <span>Thu</span>
      <span>Fri</span>
      <span>Sat</span>
    </div>

    <div class="heatmap">
      {
        weeks.map((week) => (
          <div class="heatmap-week">
            {week.map((day) => (
              <div
                class={`heatmap-day level-${getLevel(day.count)}`}
                data-date={day.date}
                data-count={day.count}
                title={
                  day.date
                    ? `${day.date}: ${day.count} thought${day.count !== 1 ? "s" : ""}`
                    : ""
                }
              />
            ))}
          </div>
        ))
      }
    </div>
  </div>

  <div id="heatmap-tooltip" class="heatmap-tooltip hidden"></div>
</div>

<script>
  const tooltip = document.getElementById("heatmap-tooltip");
  const days = document.querySelectorAll(".heatmap-day[data-date]");

  const wrapper = document.querySelector(".heatmap-wrapper");
  if (wrapper) {
    wrapper.scrollLeft = wrapper.scrollWidth;
  }

  days.forEach((day) => {
    day.addEventListener("mouseenter", (e: any) => {
      const date = day.getAttribute("data-date");
      const count = day.getAttribute("data-count");
      if (!date || !tooltip) return;

      tooltip.textContent = `${date}: ${count} thought${count !== "1" ? "s" : ""}`;
      tooltip.classList.remove("hidden");
    });

    day.addEventListener("mousemove", (e: any) => {
      if (!tooltip) return;
      const x = e.clientX + 10;
      const y = e.clientY - 30;
      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    });

    day.addEventListener("mouseleave", () => {
      tooltip?.classList.add("hidden");
    });
  });
</script>

<style>
  .heatmap-container {
    padding: 0;
  }

  .heatmap-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: var(--space-3);
  }

  .section-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
    color: var(--md-on-surface-variant);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .heatmap-total {
    font-size: 0.75rem;
    color: var(--md-on-surface-variant);
    opacity: 0.7;
  }

  .heatmap-wrapper {
    display: flex;
    gap: var(--space-2);
    overflow-x: auto;
    padding-bottom: var(--space-2);
  }

  .heatmap-labels {
    display: flex;
    flex-direction: column;
    gap: 3px;
    font-size: 10px;
    color: var(--md-on-surface-variant);
    padding-top: 2px;
  }

  .heatmap-labels span {
    height: 12px;
    line-height: 12px;
  }

  .heatmap-labels span:nth-child(even) {
    visibility: hidden;
  }

  .heatmap {
    display: flex;
    gap: 3px;
  }

  .heatmap-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .heatmap-day {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    background: var(--heatmap-0);
    transition:
      transform 0.1s ease-in-out,
      box-shadow 0.1s;
    cursor: pointer;
  }

  .heatmap-day:hover {
    transform: scale(1.4);
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .heatmap-day.level-1 {
    background: var(--heatmap-1);
  }
  .heatmap-day.level-2 {
    background: var(--heatmap-2);
  }
  .heatmap-day.level-3 {
    background: var(--heatmap-3);
  }
  .heatmap-day.level-4 {
    background: var(--heatmap-4);
  }

  .heatmap-day[data-count="-1"] {
    visibility: hidden;
  }

  .heatmap-tooltip {
    position: fixed;
    background: var(--md-on-surface);
    color: var(--md-surface);
    padding: var(--space-1) var(--space-2);
    border-radius: 4px;
    font-size: 0.75rem;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: var(--shadow-md);
  }

  .hidden {
    display: none !important;
  }
</style>
